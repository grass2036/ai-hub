# AI Hub 平台生产环境部署指南

## 目录

1. [部署概述](#部署概述)
2. [环境准备](#环境准备)
3. [Docker 部署](#docker-部署)
4. [Kubernetes 部署](#kubernetes-部署)
5. [负载均衡配置](#负载均衡配置)
6. [数据库配置](#数据库配置)
7. [安全配置](#安全配置)
8. [监控配置](#��控配置)
9. [备份策略](#备份策略)
10. [运维管理](#运维管理)

## 部署概述

AI Hub 平台支持多种部署方式，推荐使用 Docker 容器化部署。本指南将详细介绍生产环境的完整部署流程。

### 系统架构

```
[负载均衡器 Nginx]
       ↓
[前端容器 Next.js]
[后端容器 FastAPI]
       ↓
[数据库 PostgreSQL]
[缓存 Redis]
       ↓
[AI 服务 OpenRouter/Gemini]
```

### 资源要求

**最小配置**:
- CPU: 4 核心
- 内存: 8GB RAM
- 存储: 100GB SSD
- 网络: 100Mbps

**推荐配置**:
- CPU: 8 核心
- 内存: 16GB RAM
- 存储: 500GB SSD
- 网络: 1Gbps

## 环境准备

### 系统要求

- **操作系统**: Ubuntu 20.04+ / CentOS 8+ / RHEL 8+
- **Docker**: 20.10+
- **Docker Compose**: 2.0+
- **Kubernetes**: 1.24+ (可选)

### 端口规划

| 服务 | 端口 | 说明 |
|------|------|------|
| Nginx | 80, 443 | HTTP/HTTPS |
| Frontend | 3000 | Next.js 应用 |
| Backend | 8000 | FastAPI 应用 |
| PostgreSQL | 5432 | 数据库 |
| Redis | 6379 | 缓存 |
| Prometheus | 9090 | 监控 |
| Grafana | 3001 | 监控面板 |

### 域名和证书

准备以下域名和 SSL 证书：
- 主域名: `api.aihub.com`
- 监控域名: `monitor.aihub.com`
- SSL 证书: 推荐使用 Let's Encrypt

## Docker 部署

### 1. 克隆代码仓库

```bash
# 克隆项目
git clone https://github.com/your-org/ai-hub.git
cd ai-hub

# 切换到生产分支
git checkout production
```

### 2. 配置环境变量

创建生产环境配置文件：

```bash
# 复制环境变量模板
cp .env.example .env.production
```

编辑 `.env.production` 文件：

```bash
# 环境设置
ENVIRONMENT=production
DEBUG=false

# 应用配置
SECRET_KEY=your-super-secret-key-here-change-in-production
JWT_SECRET_KEY=your-jwt-secret-key-here
ALLOWED_HOSTS=api.aihub.com,www.aihub.com
CORS_ORIGINS=https://aihub.com,https://www.aihub.com

# API 服务配置
OPENROUTER_API_KEY=sk-or-v1-your-openrouter-key
GEMINI_API_KEY=your-gemini-api-key

# 数据库配置
DATABASE_URL=postgresql://aihub_user:your_password@postgres:5432/aihub_prod
REDIS_URL=redis://redis:6379/0

# 安全配置
SSL_CERT_PATH=/etc/ssl/certs/aihub.com.crt
SSL_KEY_PATH=/etc/ssl/private/aihub.com.key

# 监控配置
PROMETHEUS_ENABLED=true
GRAFANA_ADMIN_PASSWORD=your-grafana-password

# 邮件配置（可选）
SMTP_HOST=smtp.your-domain.com
SMTP_PORT=587
SMTP_USER=noreply@aihub.com
SMTP_PASSWORD=your-smtp-password
```

### 3. 创建生产环境 Docker Compose

创建 `docker-compose.prod.yml`：

```yaml
version: '3.8'

services:
  # Nginx 反向代理
  nginx:
    image: nginx:alpine
    container_name: aihub-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deployment/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./deployment/ssl:/etc/ssl:ro
      - ./deployment/logs/nginx:/var/log/nginx
    depends_on:
      - frontend
      - backend
    restart: unless-stopped
    networks:
      - aihub-network

  # 前端应用
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    container_name: aihub-frontend
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=https://api.aihub.com
    restart: unless-stopped
    networks:
      - aihub-network

  # 后端应用
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    container_name: aihub-backend
    env_file:
      - .env.production
    environment:
      - ENVIRONMENT=production
    volumes:
      - ./data:/app/data
      - ./deployment/logs/backend:/app/logs
    depends_on:
      - postgres
      - redis
    restart: unless-stopped
    networks:
      - aihub-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # PostgreSQL 数据库
  postgres:
    image: postgres:15-alpine
    container_name: aihub-postgres
    environment:
      - POSTGRES_DB=aihub_prod
      - POSTGRES_USER=aihub_user
      - POSTGRES_PASSWORD=your_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./deployment/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - ./deployment/backup:/backup
    restart: unless-stopped
    networks:
      - aihub-network

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: aihub-redis
    command: redis-server --appendonly yes --requirepass your_redis_password
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - aihub-network

  # Prometheus 监控
  prometheus:
    image: prom/prometheus:latest
    container_name: aihub-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    volumes:
      - ./deployment/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    restart: unless-stopped
    networks:
      - aihub-network

  # Grafana 监控面板
  grafana:
    image: grafana/grafana:latest
    container_name: aihub-grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=your-grafana-password
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./deployment/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./deployment/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    restart: unless-stopped
    networks:
      - aihub-network

volumes:
  postgres_data:
  redis_data:
  prometheus_data:
  grafana_data:

networks:
  aihub-network:
    driver: bridge
```

### 4. 配置 Nginx

创建 `deployment/nginx/nginx.conf`：

```nginx
events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                   '$status $body_bytes_sent "$http_referer" '
                   '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    # 基本配置
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 10M;

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript
               application/javascript application/xml+rss
               application/json application/xml;

    # 上游服务器
    upstream backend {
        server backend:8000;
    }

    upstream frontend {
        server frontend:3000;
    }

    # HTTP 重定向到 HTTPS
    server {
        listen 80;
        server_name aihub.com www.aihub.com api.aihub.com;
        return 301 https://$server_name$request_uri;
    }

    # HTTPS 主站
    server {
        listen 443 ssl http2;
        server_name aihub.com www.aihub.com;

        # SSL 配置
        ssl_certificate /etc/ssl/aihub.com.crt;
        ssl_certificate_key /etc/ssl/aihub.com.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
        ssl_prefer_server_ciphers off;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        # 安全头
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";

        location / {
            proxy_pass http://frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # API 子域名
    server {
        listen 443 ssl http2;
        server_name api.aihub.com;

        # SSL 配置（同上）
        ssl_certificate /etc/ssl/aihub.com.crt;
        ssl_certificate_key /etc/ssl/aihub.com.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
        ssl_prefer_server_ciphers off;

        # 安全头
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";

        # CORS 配置
        add_header Access-Control-Allow-Origin "https://aihub.com" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;

        if ($request_method = 'OPTIONS') {
            return 204;
        }

        location / {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 支持流式响应
            proxy_buffering off;
            proxy_cache off;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            chunked_transfer_encoding off;
        }

        # 健康检查
        location /health {
            proxy_pass http://backend/api/v1/health;
            access_log off;
        }
    }
}
```

### 5. 部署应用

```bash
# 构建并启动服务
docker-compose -f docker-compose.prod.yml up -d

# 查看服务状态
docker-compose -f docker-compose.prod.yml ps

# 查看日志
docker-compose -f docker-compose.prod.yml logs -f
```

### 6. 验证部署

```bash
# 检查服务健康状态
curl -k https://api.aihub.com/api/v1/health

# 检查前端
curl -k https://aihub.com

# 检查数据库连接
docker-compose -f docker-compose.prod.yml exec backend python -c "
from backend.config.database import engine
try:
    with engine.connect() as conn:
        result = conn.execute('SELECT 1')
        print('数据库连接成功')
except Exception as e:
    print(f'数据库连接失败: {e}')
"
```

## Kubernetes 部署

### 1. 创建命名空间

```yaml
# namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: aihub
```

### 2. 配置密钥

```yaml
# secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: aihub-secrets
  namespace: aihub
type: Opaque
data:
  SECRET_KEY: <base64-encoded-secret>
  JWT_SECRET_KEY: <base64-encoded-jwt-secret>
  OPENROUTER_API_KEY: <base64-encoded-openrouter-key>
  GEMINI_API_KEY: <base64-encoded-gemini-key>
  DATABASE_URL: <base64-encoded-database-url>
```

### 3. 部署配置

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: aihub-backend
  namespace: aihub
spec:
  replicas: 3
  selector:
    matchLabels:
      app: aihub-backend
  template:
    metadata:
      labels:
        app: aihub-backend
    spec:
      containers:
      - name: backend
        image: aihub/backend:latest
        ports:
        - containerPort: 8000
        env:
        - name: ENVIRONMENT
          value: "production"
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: aihub-secrets
              key: SECRET_KEY
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /api/v1/health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /api/v1/health
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: aihub-backend-service
  namespace: aihub
spec:
  selector:
    app: aihub-backend
  ports:
  - port: 80
    targetPort: 8000
  type: ClusterIP
```

### 4. Ingress 配置

```yaml
# ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: aihub-ingress
  namespace: aihub
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  tls:
  - hosts:
    - api.aihub.com
    - aihub.com
    secretName: aihub-tls
  rules:
  - host: api.aihub.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: aihub-backend-service
            port:
              number: 80
  - host: aihub.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: aihub-frontend-service
            port:
              number: 80
```

### 5. 部署到集群

```bash
# 应用配置
kubectl apply -f namespace.yaml
kubectl apply -f secrets.yaml
kubectl apply -f deployment.yaml
kubectl apply -f ingress.yaml

# 检查部署状态
kubectl get pods -n aihub
kubectl get services -n aihub
kubectl get ingress -n aihub
```

## 负载均衡配置

### AWS ALB 配置

```bash
# 创建 ALB
aws elbv2 create-load-balancer \
  --name aihub-alb \
  --subnets subnet-12345678 subnet-87654321 \
  --security-groups sg-12345678 \
  --scheme internet-facing \
  --type application

# 创建目标组
aws elbv2 create-target-group \
  --name aihub-backend-tg \
  --protocol HTTP \
  --port 8000 \
  --vpc-id vpc-12345678 \
  --health-check-path /api/v1/health \
  --health-check-interval-seconds 30 \
  --health-check-timeout-seconds 5 \
  --healthy-threshold-count 2 \
  --unhealthy-threshold-count 3

# 注册实例
aws elbv2 register-targets \
  --target-group-arn arn:aws:elasticloadbalancing:... \
  --targets Id=i-12345678 Id=i-87654321
```

### HAProxy 配置

```bash
# /etc/haproxy/haproxy.cfg
global
    daemon
    maxconn 4096

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

frontend aihub_frontend
    bind *:80
    bind *:443 ssl crt /etc/ssl/aihub.com.pem
    redirect scheme https if !{ ssl_fc }

    acl is_api hdr_end(host) -i api.aihub.com
    acl is_web hdr_end(host) -i aihub.com

    use_backend aihub_backend if is_api
    use_backend aihub_frontend if is_web

backend aihub_backend
    balance roundrobin
    option httpchk GET /api/v1/health
    server backend1 10.0.1.10:8000 check
    server backend2 10.0.1.11:8000 check
    server backend3 10.0.1.12:8000 check

backend aihub_frontend
    balance roundrobin
    option httpchk GET /
    server frontend1 10.0.1.20:3000 check
    server frontend2 10.0.1.21:3000 check
```

## 数据库配置

### PostgreSQL 生产配置

```sql
-- postgresql.conf 优化配置
shared_buffers = 256MB                  # 25% of RAM
effective_cache_size = 1GB              # 75% of RAM
maintenance_work_mem = 64MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
random_page_cost = 1.1
effective_io_concurrency = 200
work_mem = 4MB
min_wal_size = 1GB
max_wal_size = 4GB
max_connections = 200
```

### 数据库初始化脚本

```sql
-- init.sql
CREATE DATABASE aihub_prod;
CREATE USER aihub_user WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE aihub_prod TO aihub_user;

-- 连接到 aihub_prod 数据库
\c aihub_prod;

-- 创建扩展
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm";

-- 设置时区
SET timezone = 'UTC';

-- 创建索引优化查询
-- 将在应用启动时自动创建表和索引
```

### Redis 配置

```conf
# redis.conf
bind 0.0.0.0
port 6379
requirepass your_redis_password
maxmemory 512mb
maxmemory-policy allkeys-lru
save 900 1
save 300 10
save 60 10000
appendonly yes
appendfsync everysec
```

## 安全配置

### 防火墙配置

```bash
# UFW 防火墙规则
ufw default deny incoming
ufw default allow outgoing
ufw allow ssh
ufw allow 80/tcp
ufw allow 443/tcp
ufw enable

# iptables 规则（更详细）
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT
iptables -A INPUT -j DROP
```

### SSL/TLS 配置

```bash
# 使用 Let's Encrypt 获取证书
certbot certonly --standalone -d aihub.com -d api.aihub.com

# 自动续期配置
echo "0 12 * * * /usr/bin/certbot renew --quiet" | crontab -

# 配置强加密套件
# 在 nginx.conf 中已配置
```

### 应用安全配置

```python
# 安全中间件配置
from fastapi.middleware.cors import CORSMiddleware
from fastapi.middleware.httpsredirect import HTTPSRedirectMiddleware
from fastapi.middleware.trustedhost import TrustedHostMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://aihub.com"],
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE"],
    allow_headers=["*"],
)

app.add_middleware(HTTPSRedirectMiddleware)
app.add_middleware(
    TrustedHostMiddleware,
    allowed_hosts=["aihub.com", "*.aihub.com", "localhost"]
)
```

## 监控配置

### Prometheus 配置

```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "rules/*.yml"

scrape_configs:
  - job_name: 'aihub-backend'
    static_configs:
      - targets: ['backend:8000']
    metrics_path: '/metrics'
    scrape_interval: 5s

  - job_name: 'nginx'
    static_configs:
      - targets: ['nginx:9113']

  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']

  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093
```

### Grafana 仪表板

```json
{
  "dashboard": {
    "title": "AI Hub Platform Overview",
    "panels": [
      {
        "title": "API 请求率",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])",
            "legendFormat": "{{method}} {{endpoint}}"
          }
        ]
      },
      {
        "title": "响应时间",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "95th percentile"
          }
        ]
      },
      {
        "title": "错误率",
        "type": "singlestat",
        "targets": [
          {
            "expr": "rate(http_requests_total{status=~\"5..\"}[5m]) / rate(http_requests_total[5m])",
            "legendFormat": "Error Rate"
          }
        ]
      }
    ]
  }
}
```

### 告警规则

```yaml
# alerts.yml
groups:
- name: aihub_alerts
  rules:
  - alert: HighErrorRate
    expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "High error rate detected"
      description: "Error rate is {{ $value | humanizePercentage }}"

  - alert: HighResponseTime
    expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High response time detected"
      description: "95th percentile response time is {{ $value }}s"

  - alert: DatabaseConnectionFailure
    expr: up{job="postgres"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Database connection failure"
      description: "PostgreSQL database is down"
```

## 备份策略

### 数据库备份脚本

```bash
#!/bin/bash
# backup_database.sh

BACKUP_DIR="/backup"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="aihub_prod"
DB_USER="aihub_user"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
docker-compose -f docker-compose.prod.yml exec -T postgres pg_dump \
  -U $DB_USER \
  -d $DB_NAME \
  --format=custom \
  --compress=9 \
  > $BACKUP_DIR/aihub_backup_$DATE.dump

# 压缩备份文件
gzip $BACKUP_DIR/aihub_backup_$DATE.dump

# 删除 7 天前的备份
find $BACKUP_DIR -name "aihub_backup_*.dump.gz" -mtime +7 -delete

# 上传到云存储（可选）
# aws s3 cp $BACKUP_DIR/aihub_backup_$DATE.dump.gz s3://aihub-backups/

echo "数据库备份完成: aihub_backup_$DATE.dump.gz"
```

### 应用数据备份

```bash
#!/bin/bash
# backup_application.sh

BACKUP_DIR="/backup"
DATE=$(date +%Y%m%d_%H%M%S)
APP_DATA_DIR="/app/data"

# 备份应用数据
tar -czf $BACKUP_DIR/app_data_$DATE.tar.gz -C $APP_DATA_DIR .

# 删除 30 天前的备份
find $BACKUP_DIR -name "app_data_*.tar.gz" -mtime +30 -delete

echo "应用数据备份完成: app_data_$DATE.tar.gz"
```

### 自动备份配置

```bash
# 添加到 crontab
crontab -e

# 每天凌晨 2 点备份数据库
0 2 * * * /path/to/backup_database.sh

# 每周日凌晨 3 点备份应用数据
0 3 * * 0 /path/to/backup_application.sh

# 每月 1 号检查备份完整性
0 4 1 * * /path/to/check_backups.sh
```

## 运维管理

### 日志管理

```bash
# 日志轮转配置
cat > /etc/logrotate.d/aihub << EOF
/var/log/aihub/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 root root
    postrotate
        docker-compose -f /path/to/docker-compose.prod.yml restart nginx
    endscript
}
EOF
```

### 健康检查脚本

```bash
#!/bin/bash
# health_check.sh

API_URL="https://api.aihub.com/api/v1/health"
WEB_URL="https://aihub.com"

# 检查 API 健康状态
api_status=$(curl -s -o /dev/null -w "%{http_code}" $API_URL)
if [ $api_status -eq 200 ]; then
    echo "✅ API 服务正常"
else
    echo "❌ API 服务异常 (HTTP $api_status)"
    # 发送告警
    curl -X POST "https://hooks.slack.com/your-webhook" \
         -d '{"text":"AI Hub API 服务异常"}'
fi

# 检查前端健康状态
web_status=$(curl -s -o /dev/null -w "%{http_code}" $WEB_URL)
if [ $web_status -eq 200 ]; then
    echo "✅ 前端服务正常"
else
    echo "❌ 前端服务异常 (HTTP $web_status)"
fi

# 检查数据库连接
db_status=$(docker-compose -f docker-compose.prod.yml exec -T postgres pg_isready -U aihub_user)
if [[ $db_status == *"accepting connections"* ]]; then
    echo "✅ 数据库连接正常"
else
    echo "❌ 数据库连接异常"
fi
```

### 更新部署脚本

```bash
#!/bin/bash
# deploy_update.sh

set -e

echo "开始部署 AI Hub 平台更新..."

# 拉取最新代码
git pull origin production

# 备份当前版本
docker-compose -f docker-compose.prod.yml exec postgres pg_dump \
  -U aihub_user -d aihub_prod > /backup/pre_update_$(date +%Y%m%d_%H%M%S).sql

# 构建新镜像
docker-compose -f docker-compose.prod.yml build --no-cache

# 滚动更新
docker-compose -f docker-compose.prod.yml up -d --no-deps backend
docker-compose -f docker-compose.prod.yml up -d --no-deps frontend

# 等待服务启动
sleep 30

# 健康检查
./health_check.sh

echo "部署更新完成！"
```

### 监控脚本

```bash
#!/bin/bash
# monitor_resources.sh

# CPU 使用率
cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | awk -F'%' '{print $1}')
echo "CPU 使用率: $cpu_usage%"

# 内存使用率
memory_usage=$(free | grep Mem | awk '{printf("%.1f"), $3/$2 * 100.0}')
echo "内存使用率: $memory_usage%"

# 磁盘使用率
disk_usage=$(df -h / | awk 'NR==2 {print $5}')
echo "磁盘使用率: $disk_usage"

# Docker 容器状态
echo "Docker 容器状态:"
docker-compose -f docker-compose.prod.yml ps

# 检查是否有异常容器
failed_containers=$(docker-compose -f docker-compose.prod.yml ps | grep -c "Exit")
if [ $failed_containers -gt 0 ]; then
    echo "⚠️  发现 $failed_containers 个异常容器"
fi
```

### 故障恢复流程

1. **服务异常**:
   ```bash
   # 重启服务
   docker-compose -f docker-compose.prod.yml restart backend

   # 查看日志
   docker-compose -f docker-compose.prod.yml logs -f backend
   ```

2. **数据库异常**:
   ```bash
   # 检查数据库状态
   docker-compose -f docker-compose.prod.yml exec postgres pg_isready

   # 重启数据库
   docker-compose -f docker-compose.prod.yml restart postgres
   ```

3. **性能问题**:
   ```bash
   # 查看资源使用
   docker stats

   # 扩容服务
   docker-compose -f docker-compose.prod.yml up -d --scale backend=3
   ```

通过遵循这个部署指南，您可以在生产环境中稳定、安全地运行 AI Hub 平台。定期的监控、备份和维护将确保平台的持续可用性和性能。