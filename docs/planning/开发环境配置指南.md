# AI Hub 开发环境配置指南

> 从零开始的完整开发环境搭建 - macOS版本

**适用系统**: macOS (Apple Silicon & Intel)
**预计时间**: 30-60分钟
**难度**: 简单

---

## 📋 前置要求

### 系统要求
- macOS 12.0+ (Monterey或更新版本)
- 至少8GB RAM
- 至少20GB可用磁盘空间
- 稳定的网络连接

### 需要的账号
- GitHub账号（用于代码管理）
- OpenRouter账号（获取API密钥）
- Gemini账号（可选，备用AI服务）

---

## 🛠️ 安装工具清单

### 1. Homebrew（macOS包管理器）

如果还没安装Homebrew：

```bash
# 安装Homebrew
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 验证安装
brew --version
# 预期输出: Homebrew 4.x.x
```

**如果brew命令未找到**（Apple Silicon Mac）：
```bash
# 添加到PATH
echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zshrc
source ~/.zshrc
```

---

### 2. Python 3.11+

#### 检查Python版本

```bash
python3 --version
```

#### 如果版本<3.11，安装新版本：

```bash
# 使用Homebrew安装Python 3.11
brew install python@3.11

# 验证安装
python3.11 --version

# 设置别名（添加到~/.zshrc）
echo 'alias python=python3.11' >> ~/.zshrc
echo 'alias pip=pip3.11' >> ~/.zshrc
source ~/.zshrc
```

#### 升级pip

```bash
python -m pip install --upgrade pip
pip --version
# 预期输出: pip 24.x.x
```

---

### 3. PostgreSQL 14+

#### 安装PostgreSQL

```bash
# 使用Homebrew安装
brew install postgresql@14

# 启动PostgreSQL服务
brew services start postgresql@14

# 验证安装
psql --version
# 预期输出: psql (PostgreSQL) 14.x
```

#### 初始化PostgreSQL

```bash
# 连接到PostgreSQL
psql postgres

# 如果提示找不到postgres用户，创建它
createdb $(whoami)
psql postgres
```

#### 创建超级用户（如果需要）

```sql
-- 在psql中执行
CREATE USER postgres WITH PASSWORD 'postgres' SUPERUSER;

-- 退出
\q
```

#### 测试连接

```bash
psql -U postgres -c "SELECT version();"
```

---

### 4. Redis

#### 安装Redis

```bash
# 使用Homebrew安装
brew install redis

# 启动Redis服务
brew services start redis

# 验证安装
redis-cli --version
# 预期输出: redis-cli 7.x.x
```

#### 测试Redis

```bash
# 测试连接
redis-cli ping
# 预期输出: PONG

# 测试基本操作
redis-cli
127.0.0.1:6379> SET test "hello"
127.0.0.1:6379> GET test
# 应该返回 "hello"
127.0.0.1:6379> exit
```

---

### 5. Node.js 18+ (用于前端开发)

#### 安装Node.js

```bash
# 使用Homebrew安装
brew install node@18

# 验证安装
node --version
# 预期输出: v18.x.x

npm --version
# 预期输出: 9.x.x
```

#### 配置npm镜像（加速下载，可选）

```bash
# 使用淘宝镜像
npm config set registry https://registry.npmmirror.com
```

---

### 6. Git

#### 检查Git

```bash
git --version
# macOS通常自带Git
```

#### 配置Git（如果是第一次使用）

```bash
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"

# 验证配置
git config --list | grep user
```

---

### 7. VS Code（推荐的代码编辑器）

#### 下载安装

1. 访问 https://code.visualstudio.com/
2. 下载macOS版本
3. 安装到Applications文件夹

#### 安装命令行工具

在VS Code中：
1. 按 `Cmd+Shift+P`
2. 输入 "Shell Command: Install 'code' command in PATH"
3. 选择该选项

验证：
```bash
code --version
```

#### 推荐的VS Code扩展

```bash
# 安装扩展（通过命令行）
code --install-extension ms-python.python
code --install-extension ms-python.vscode-pylance
code --install-extension esbenp.prettier-vscode
code --install-extension dbaeumer.vscode-eslint
code --install-extension bradlc.vscode-tailwindcss
code --install-extension ms-vscode.vscode-typescript-next
```

或在VS Code中搜索安装：
- Python (Microsoft)
- Pylance (Microsoft)
- Prettier - Code formatter
- ESLint
- Tailwind CSS IntelliSense
- Database Client (可选，查看数据库)

---

## 🔧 项目环境设置

### 1. 克隆项目

```bash
# 进入工作目录
cd ~/code/git

# 如果项目已存在
cd ai-hub

# 如果是新项目
git clone https://github.com/yourusername/ai-hub.git
cd ai-hub
```

---

### 2. 后端环境配置

#### 创建Python虚拟环境

```bash
# 在项目根目录
python -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 验证（命令行前应该显示(venv)）
which python
# 应该显示项目目录下的venv路径
```

#### 安装Python依赖

创建或更新 `requirements.txt`：

```txt
# Web框架
fastapi==0.104.1
uvicorn[standard]==0.24.0
pydantic==2.5.0
pydantic-settings==2.1.0

# 数据库
sqlalchemy==2.0.23
asyncpg==0.29.0
psycopg2-binary==2.9.9
alembic==1.13.0

# Redis
redis==5.0.1

# 认证和安全
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4
python-multipart==0.0.6

# HTTP客户端
aiohttp==3.9.1
httpx==0.25.2

# 工具
python-dotenv==1.0.0
tiktoken==0.5.2

# 测试
pytest==7.4.3
pytest-asyncio==0.21.1
pytest-cov==4.1.0

# 代码质量（可选）
black==23.12.0
isort==5.13.2
flake8==6.1.0
mypy==1.7.1
```

安装依赖：

```bash
pip install -r requirements.txt

# 验证安装
pip list | grep fastapi
# 应该看到fastapi和相关包
```

#### 创建.env文件

```bash
# 复制示例文件
cp .env.example .env

# 编辑.env文件
code .env
```

.env文件内容：

```bash
# 应用配置
APP_NAME=AI Hub
ENVIRONMENT=development
DEBUG=true

# 数据库配置
DATABASE_URL=postgresql+asyncpg://ai_hub_user:your_secure_password@localhost:5432/ai_hub

# Redis配置
REDIS_URL=redis://localhost:6379/0

# JWT配置
JWT_SECRET_KEY=change-this-to-a-random-secret-key-min-32-chars-abc123xyz789
JWT_ALGORITHM=HS256
JWT_EXPIRE_DAYS=7

# OpenRouter API
OPENROUTER_API_KEY=sk-or-v1-xxxxxxxxxxxxx

# Gemini API
GEMINI_API_KEY=xxxxxxxxxxxxx

# CORS设置
CORS_ORIGINS=["http://localhost:3000","http://localhost:8001"]
```

**⚠️ 重要**：
1. 将`your_secure_password`改为强密码
2. 生成随机的JWT_SECRET_KEY
3. 添加你的API密钥

生成随机密钥：
```bash
python -c "import secrets; print(secrets.token_urlsafe(32))"
```

---

### 3. 数据库初始化

#### 创建数据库

```bash
# 连接到PostgreSQL
psql -U postgres

# 在psql中执行
CREATE DATABASE ai_hub;
CREATE USER ai_hub_user WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE ai_hub TO ai_hub_user;

# 退出
\q
```

#### 验证数据库连接

```bash
psql -U ai_hub_user -d ai_hub -c "SELECT 'Connected successfully!' as status;"
```

---

### 4. 前端环境配置

#### 进入前端目录

```bash
cd frontend
```

#### 创建Next.js项目（如果不存在）

```bash
npx create-next-app@latest . --typescript --tailwind --app --no-src-dir
```

选项：
- TypeScript: Yes
- ESLint: Yes
- Tailwind CSS: Yes
- App Router: Yes
- Import alias: Yes (@/*)

#### 安装依赖

```bash
npm install
```

#### 创建环境变量文件

```bash
# 创建.env.local
cat > .env.local << 'EOF'
NEXT_PUBLIC_API_URL=http://localhost:8001
EOF
```

#### 测试前端

```bash
npm run dev
# 打开浏览器访问 http://localhost:3000
```

---

## 📝 开发工具配置

### VS Code设置

创建 `.vscode/settings.json`：

```json
{
  "python.defaultInterpreterPath": "${workspaceFolder}/venv/bin/python",
  "python.linting.enabled": true,
  "python.linting.pylintEnabled": false,
  "python.linting.flake8Enabled": true,
  "python.formatting.provider": "black",
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.organizeImports": true
  },
  "[python]": {
    "editor.defaultFormatter": "ms-python.black-formatter",
    "editor.tabSize": 4
  },
  "[typescript]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode",
    "editor.tabSize": 2
  },
  "[typescriptreact]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode",
    "editor.tabSize": 2
  },
  "files.exclude": {
    "**/__pycache__": true,
    "**/*.pyc": true,
    ".pytest_cache": true,
    "**/.next": true,
    "**/node_modules": true
  }
}
```

创建 `.vscode/launch.json`（调试配置）：

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Python: FastAPI",
      "type": "python",
      "request": "launch",
      "module": "uvicorn",
      "args": [
        "backend.main:app",
        "--reload",
        "--port",
        "8001"
      ],
      "jinja": true,
      "justMyCode": true,
      "env": {
        "PYTHONPATH": "${workspaceFolder}"
      }
    },
    {
      "name": "Python: Current File",
      "type": "python",
      "request": "launch",
      "program": "${file}",
      "console": "integratedTerminal",
      "justMyCode": true
    },
    {
      "name": "Python: Pytest",
      "type": "python",
      "request": "launch",
      "module": "pytest",
      "args": [
        "-v",
        "${workspaceFolder}/backend/tests"
      ],
      "console": "integratedTerminal",
      "justMyCode": true
    }
  ]
}
```

---

## ✅ 环境验证清单

运行以下命令验证环境配置：

```bash
# 创建验证脚本
cat > check_env.sh << 'EOF'
#!/bin/bash

echo "🔍 验证开发环境..."
echo ""

# Python
echo "1. Python版本："
python --version
echo ""

# PostgreSQL
echo "2. PostgreSQL："
psql --version
pg_isready -h localhost -p 5432
echo ""

# Redis
echo "3. Redis："
redis-cli --version
redis-cli ping
echo ""

# Node.js
echo "4. Node.js："
node --version
npm --version
echo ""

# Git
echo "5. Git："
git --version
echo ""

# 虚拟环境
echo "6. Python虚拟环境："
if [ -d "venv" ]; then
    echo "✓ venv目录存在"
    source venv/bin/activate
    pip list | grep fastapi
    deactivate
else
    echo "✗ venv目录不存在"
fi
echo ""

# 数据库连接
echo "7. 数据库连接："
psql -U postgres -c "SELECT 'OK' as status;" 2>/dev/null
echo ""

echo "✅ 环境验证完成！"
EOF

chmod +x check_env.sh
./check_env.sh
```

预期输出：

```
🔍 验证开发环境...

1. Python版本：
Python 3.11.x

2. PostgreSQL：
psql (PostgreSQL) 14.x
/tmp:5432 - accepting connections

3. Redis：
redis-cli 7.x.x
PONG

4. Node.js：
v18.x.x
9.x.x

5. Git：
git version 2.x.x

6. Python虚拟环境：
✓ venv目录存在
fastapi         0.104.1

7. 数据库连接：
 status
--------
 OK

✅ 环境验证完成！
```

---

## 🚀 快速启动命令

### 后端启动

```bash
# 激活虚拟环境
source venv/bin/activate

# 启动FastAPI
python backend/main.py

# 或使用uvicorn
uvicorn backend.main:app --reload --port 8001
```

访问：
- API: http://localhost:8001
- 文档: http://localhost:8001/docs
- 健康检查: http://localhost:8001/health

### 前端启动

```bash
# 进入前端目录
cd frontend

# 启动开发服务器
npm run dev
```

访问: http://localhost:3000

### 数据库管理

```bash
# 连接数据库
psql -U ai_hub_user -d ai_hub

# 查看所有表
\dt

# 查看表结构
\d users

# 查询数据
SELECT * FROM users;

# 退出
\q
```

### Redis管理

```bash
# 连接Redis
redis-cli

# 查看所有key
KEYS *

# 查看特定key
GET quota:user:1

# 清空数据库（慎用！）
FLUSHDB

# 退出
exit
```

---

## 🐛 常见问题排查

### 1. PostgreSQL连接失败

**错误**: `psql: error: connection to server on socket "/tmp/.s.PGSQL.5432" failed`

**解决**:
```bash
# 检查PostgreSQL是否运行
brew services list | grep postgresql

# 如果未运行，启动它
brew services start postgresql@14

# 检查端口
lsof -i :5432
```

### 2. Redis连接失败

**错误**: `Could not connect to Redis at 127.0.0.1:6379`

**解决**:
```bash
# 启动Redis
brew services start redis

# 检查状态
brew services info redis

# 手动启动（前台运行）
redis-server
```

### 3. Python导入错误

**错误**: `ModuleNotFoundError: No module named 'backend'`

**解决**:
```bash
# 确保在项目根目录
pwd

# 设置PYTHONPATH
export PYTHONPATH="${PYTHONPATH}:$(pwd)"

# 或添加到.env
echo 'PYTHONPATH=.' >> .env
```

### 4. 端口被占用

**错误**: `Address already in use: 8001`

**解决**:
```bash
# 查找占用端口的进程
lsof -ti:8001

# 杀死进程
kill -9 $(lsof -ti:8001)
```

### 5. npm安装慢

**解决**:
```bash
# 使用淘宝镜像
npm config set registry https://registry.npmmirror.com

# 或使用cnpm
npm install -g cnpm --registry=https://registry.npmmirror.com
cnpm install
```

---

## 📚 有用的命令速查

### 开发流程

```bash
# 每天开始工作
cd ~/code/git/ai-hub
source venv/bin/activate
brew services start postgresql@14
brew services start redis
python backend/main.py

# 新终端窗口启动前端
cd ~/code/git/ai-hub/frontend
npm run dev

# 运行测试
pytest backend/tests/ -v

# 代码格式化
black backend/
isort backend/

# Git提交
git add .
git commit -m "feat: 添加新功能"
git push
```

### 数据库操作

```bash
# 备份数据库
pg_dump -U ai_hub_user ai_hub > backup.sql

# 恢复数据库
psql -U ai_hub_user ai_hub < backup.sql

# 重置数据库
dropdb ai_hub
createdb ai_hub
psql -U ai_hub_user -d ai_hub -f migrations/001_initial_schema.sql
```

---

## 🎉 完成！

环境配置完成后，你应该能够：

✅ 启动PostgreSQL和Redis
✅ 激活Python虚拟环境
✅ 运行FastAPI后端
✅ 运行Next.js前端
✅ 运行单元测试
✅ 连接数据库和Redis

**下一步**：开始 [Day 1执行清单](./Day1-执行清单.md)

---

**提示**: 将这个文档加入书签，遇到环境问题时随时查阅！

**需要帮助？**
- 检查错误日志
- 搜索错误信息
- 查看官方文档
- 在团队内询问

祝开发顺利！🚀
